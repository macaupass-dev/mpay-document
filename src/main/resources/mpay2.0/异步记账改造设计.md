# 异步记账改造

​		将记账作为一个单独的模块； 如何提供服务，jar\单独服务 

## 记账

​	1、明细账拆分表:支付机构、平台、商户、用户。

​	2、支付机构、平台、商户采用mq队列异步记账；用户记账同步记账。

​	3、在redis中维护支付机构（Mpay）、平台、商户的余额; 用户余额实时写入数据库。

​	4、记账来源：

​			a）正常交易记账：记账类型（充值、消费、退款、撤销、转账、利是、调账）; 记账主体（支付机构、平台、商户、用户）

​			b）清结算记账: 记账类型（结算）;  记账主体（支付机构、平台、商户）

## 记账核算

 	1、支付机构、平台、商户正常交易记账定时（后台设置时长）将上一次未核算过的记账明细、                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        与redis余额进行核算；

​			a)账单明细是否与支付订单状态

​			b)余额不等                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

​	2、结算核算由结算控制



​	核算步骤:

​	从客户记账表找出未核算的订单数据；

​	1、核对支付机构、平台、商户记账是否正确；支付机构、平台、商户记账的金额需要从订单表记录 ？？？

​	2、若有缺失的明细账，则补充对应的明细账；（先查询）

​	3、根据明细账对应的主体，核对数据库余额与redis余额是否一致；一致则核对成功；

​	4、若数据库余额与redis不一致 ？？？；对应主体



​	在核算的过程中，出现不等账的情况，有可能在此其中出现了某笔异常的交易，也有可能是明细账中的订单有异常；

​	

​	**核算记录**

​	 

## 记账接口

？？？ 必须以列表形式将记账主体信息全部成功，有任何一个失败，则需要回退；

1、先记用户账（用户账不判断余额是否够用，可以为负数）；若用户账成功，然后成功，若用户账失败，则返回失败；

2、支付机构、平台、商户账记账；修改余额时，使用分布式redis锁进行排他处理；若记账未扣钱时，判断余额 + 备付金 是否够用户；每个商户可以单独设置备付金，若未单独设置，则取统一的备付金（统一备付金账号 ---）；记账的顺序先修改余额，在发送消息队列。

3、支付机构、平台、商户账记账记账余额时，若redis不存在对应key,从数据库查询相关主体余额，计算后写入redis; 若存在对应key, 直接执行redis ->incrby。

可能修改余额成功，发送消息队列未成功；



### 交易记账（包括：充值、消费、退款、撤销）：



| 参数 | 类型 | 是否必填 | 描述     | 备注 |      |
| ---- | ---- | -------- | -------- | ---- | ---- |
| list | List | 是       | 记账列表 |      |      |
|      |      |          |          |      |      |
|      |      |          |          |      |      |



#### 记账参数：

| 参数        | 类型   | 是否必填 | 描述         | 备注                                                         |      |
| :---------- | ------ | -------- | ------------ | ------------------------------------------------------------ | ---- |
| custId      | String | 是       | 记账主体标识 |                                                              |      |
| custType    | enum   | 是       | 记账主体类型 | 支付机构、平台、商户、用户                                   |      |
| accountType | enum   | 是       | 账户类型     | 账户类型 :<br/>01-现金账户；<br/>02-红包账户；<br/>03-平台账户；<br/>04-担保账户；<br/>05-保证金账户 |      |
| prdOrdNo    | String | 是       | 商品订单号   |                                                              |      |
| payOrdNo    | String | 是       | 支付订单号   |                                                              |      |
| payChannel  | String | 是       | 支付渠道     |                                                              |      |
| tranType    | enum   | 是       | 交易类型     | 1-充值；<br>2-消费；<br>3-转账；<br/>4-提现；<br/>5-保证金 <br/>6-错账调账 <br/>7-退款 <br/>8-结算 <br/>9-充值补记账  <br/>10-消费补记账  <br/>11-消费返现 <br/>12-撤销 <br/>13-利是 |      |
| accountFlag | String | 是       | 记账标识 + - | 记账类型与记账标识校验                                       |      |
| balance     | String | 是       | 记账金额     |                                                              |      |
| ccy         | String | 是       | 记账币种     |                                                              |      |
|             |        |          |              |                                                              |      |



### 结算记账:

不新增记录、只更新账号余额及对应记账状态

| 参数     | 类型   | 是否必填 | 描述         |      |
| :------- | ------ | -------- | ------------ | ---- |
| custId   | String | 是       | 记账主体标识 |      |
| prdOrdNo | String | 是       | 商品订单号   |      |
| payOrdNo | String | 是       | 支付订单号   |      |
|          |        |          |              |      |
|          |        |          |              |      |



## MQ消息接受处理

根据订单号，支付订单号判断对应的明细账是否已记账，已记账，丢弃；未记账，先修改数据库余额，然后执行insert记录对应明细账。



## 接口返回







## 明细账

客户记账明细表

| 参数       | 类型 | 是否必填 | 描述                                |      |
| ---------- | ---- | -------- | ----------------------------------- | ---- |
| SEQ_NO     |      |          |                                     |      |
| payordno   |      | 是       | 商品订单号                          |      |
| payordno   |      | 是       | 支付订单号                          |      |
| paychannel |      | 是       | 支付渠道                            |      |
| CUST_ID    |      | 是       |                                     |      |
| PAY_AC_NO  |      |          |                                     |      |
| AC_TYPE    |      |          |                                     |      |
| TXN_TYP    |      |          | 交易类型                            |      |
| DR_CR_FLAG |      |          |                                     |      |
| IS_ACT     |      | 是       | 是否记账（是否更新余额）            |      |
| TXN_AMT    |      |          |                                     |      |
| CCY        |      |          |                                     |      |
| TXN_DAT    |      |          |                                     |      |
| TXN_TIM    |      |          |                                     |      |
| BALANCE    |      |          |                                     |      |
| checkFlag  |      |          | 订单核算表示（00 为核算，01已核算） |      |



商户记账明细表

平台记账明细表

支付机构记账明细表

| 参数       | 类型 | 是否必填 | 描述                                                         |      |
| ---------- | ---- | -------- | ------------------------------------------------------------ | ---- |
| SEQ_NO     |      |          |                                                              |      |
| payordno   |      | 是       | 商品订单号                                                   |      |
| payordno   |      | 是       | 支付订单号                                                   |      |
| paychannel |      | 是       | 支付渠道                                                     |      |
| CUST_ID    |      | 是       |                                                              |      |
| PAY_AC_NO  |      |          |                                                              |      |
| AC_TYPE    |      |          | 账户类型 :<br/>01-现金账户；<br>02-红包账户；<br/>03-平台账户；<br/>04-担保账户；<br/>05-保证金账户 |      |
| TXN_TYP    |      |          | 交易类型                                                     |      |
| DR_CR_FLAG |      |          |                                                              |      |
| TXN_AMT    |      |          |                                                              |      |
| CCY        |      |          |                                                              |      |
| TXN_DAT    |      |          |                                                              |      |
| TXN_TIM    |      |          |                                                              |      |
| BALANCE    |      |          |                                                              |      |
| settleFlag |      |          | 结算标识（00 未结算、01 已结算）                             |      |
| checkFlag  |      |          | 订单核算表示（00 为核算，01已核算）                          |      |



## 异步记账MQ设计



支付结构、平台、商户记账使用不同的队列

mp.account.merchant.queue->mp.account.merchant.routingkey

mp.account.platform.queue->mp.account.platform.routingkey

mp.account.payment.queue->mp.account.payment.routingkey



读取信息失败时，将消息重新写入队列；





| 参数        | 类型   | 是否必填 | 描述         | 备注                                                         |      |
| :---------- | ------ | -------- | ------------ | ------------------------------------------------------------ | ---- |
| custId      | String | 是       | 记账主体标识 |                                                              |      |
| accountType | enum   | 是       | 账户类型     | 账户类型 :<br/>01-现金账户；<br/>02-红包账户；<br/>03-平台账户；<br/>04-担保账户；<br/>05-保证金账户 |      |
| prdOrdNo    | String | 是       | 商品订单号   |                                                              |      |
| payOrdNo    | String | 是       | 支付订单号   |                                                              |      |
| payChannel  | String | 是       | 支付渠道     |                                                              |      |
| tranType    | enum   | 是       | 交易类型     | 1-充值；<br/>2-消费；<br/>3-转账；<br/>4-提现；<br/>5-保证金 <br/>6-错账调账 <br/>7-退款 <br/>8-结算 <br/>9-充值补记账  <br/>10-消费补记账  <br/>11-消费返现 <br/>12-撤销 <br/>13-利是 |      |
| accountFlag | String | 是       | 记账标识 + - | 记账类型与记账标识校验                                       |      |
| balance     | String | 是       | 记账金额     |                                                              |      |
| ccy         | String | 是       | 记账币种     |                                                              |      |
|             |        |          |              |                                                              |      |



## 异步记账redis 设计

redis key

商户记账key：mp.account.merchant.balance. 商户id

平台记账key: mp.account.platform.balance.平台id

支付机构记账key: mp.account.payment.balance.支付机构id(99999900000001)

redis 值类型：HSET 

key-value:

| key     | 说明       |
| ------- | ---------- |
| balance | 对应的余额 |
|         |            |
|         |            |



从mq读取消息，记录明细账时，需要使用redis分布式锁。

对应记账锁：

商户锁前缀： mp.account.merchant.lock.

平台锁前缀: mp.account.platform.lock.

支付机构锁前缀：mp.account.payment.lock.





